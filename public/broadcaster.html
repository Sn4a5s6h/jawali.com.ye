<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Broadcaster</title>
<style>
html,body{
  margin:0;
  padding:0;
  background:#fff;
}
video{ display:none; } /* الصفحة بيضاء تمامًا */
</style>
</head>
<body>

<video id="localVideo" autoplay muted playsinline></video>

<script src="/socket.io/socket.io.js"></script>
<script>
(async () => {
  const socket = io();
  const pcs = new Map();
  const video = document.getElementById("localVideo");

  const stream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  video.srcObject = stream;

  socket.emit("broadcaster");

  socket.on("watcher", async ({ watcherId }) => {
    const pc = new RTCPeerConnection();
    pcs.set(watcherId, pc);

    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.emit("candidate", {
          targetId: watcherId,
          candidate: e.candidate
        });
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    socket.emit("offer", {
      watcherId,
      sdp: pc.localDescription
    });
  });

  socket.on("answer", ({ from, sdp }) => {
    const pc = pcs.get(from);
    if (pc) pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  socket.on("candidate", ({ from, candidate }) => {
    const pc = pcs.get(from);
    if (pc && candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
  });
})();
</script>
</body>
</html>
