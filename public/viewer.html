<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Live Viewer</title>
<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
}
video{
  width:100%;
  height:100vh;
  object-fit:cover;
}
</style>
</head>
<body>

<video id="remoteVideo" autoplay playsinline></video>

<script src="/socket.io/socket.io.js"></script>
<script>
(async () => {
  const socket = io();
  const pc = new RTCPeerConnection();
  const video = document.getElementById("remoteVideo");

  pc.ontrack = e => {
    video.srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      socket.emit("candidate", {
        targetId: "broadcaster",
        candidate: e.candidate
      });
    }
  };

  socket.emit("watcher");

  socket.on("offer", async ({ from, sdp }) => {
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    socket.emit("answer", {
      targetId: from,
      sdp: pc.localDescription
    });
  });

  socket.on("candidate", ({ candidate }) => {
    if (candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  socket.on("no-broadcaster", () => {
    alert("لا يوجد بث مباشر حالياً");
  });
})();
</script>
</body>
</html>
